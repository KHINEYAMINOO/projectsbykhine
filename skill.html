<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Owned Certification</title>
  
</head>
<style>
  body{
  margin:0;
  min-height:100svh;
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  color:#1f2937;

  /* ✅ 黒グラデーション → 明るめグレーに変更 */
  background:
    linear-gradient(180deg,rgba(255,255,255,.45),rgba(0,0,0,.15)),
    url("https://images.unsplash.com/photo-1503264116251-35a269479413?q=80&w=1974&auto=format&fit=crop")
    center/cover no-repeat #e5e7eb;
}

/* ✅ ガラスカード → 明るめ透明グレー */
.glass-box{
  width:min(94vw,900px);
  padding:28px 24px;
  border-radius:22px;
  background:rgba(255,255,255,.75);   /* ← 暗さの原因ここを調整 */
  border:1px solid rgba(120,120,120,.25);
  box-shadow:0 18px 50px rgba(0,0,0,.25);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
}

h1{
  margin:0 0 8px;
  font-size:28px;
  color:#111827;
}

p.lead{
  margin:0 0 20px;
  color:#374151;
}

form{
  display:flex;
  flex-direction:column;
  gap:18px;
}

fieldset{
  border:1px solid #d1d5db;
  border-radius:14px;
  padding:14px 14px 10px;
  background:#ffffff;
}

legend{
  padding:0 6px;
  color:#374151;
  font-weight:700;
}

label{
  display:block;
  font-size:13px;
  color:#374151;
  margin:0 0 6px;
}

.row label{
  display:inline-flex;
  gap:.5rem;
  align-items:center;
  margin-right:14px;
}

/* ✅ 入力欄：白系に統一 */
input[type="text"],
input[type="email"],
input[type="date"],
input[type="tel"],
input[type="number"],
select{
  width:80%;
  padding:10px 12px;
  font-size:16px;
  color:#111827;
  background:#f9fafb;
  border:1px solid #d1d5db;
  border-radius:10px;
  outline:none;
  transition:border-color .2s, box-shadow .2s, background .2s;
}

input::placeholder{
  color:#9ca3af;
}

input:focus,
select:focus{
  border-color:#2563eb;
  box-shadow:0 0 0 3px rgba(37,99,235,.25);
  background:#ffffff;
}

input[type="file"]{
  width:80%;
  padding:10px;
  background:#f9fafb;
  border:1px dashed #9ca3af;
  border-radius:10px;
  color:#111827;
}

/* ✅ JLPT セレクトはそのまま統一感アップ */
#jlpt{
  width:80%;
  background:#ffffff;
  color:#0f172a;
  border:1px solid #d1d5db;
  border-radius:10px;
  padding:10px 12px;
  font-size:16px;
  appearance:none;
  outline:none;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
}

#jlpt:focus{
  border-color:#2563eb;
  box-shadow:0 0 0 3px rgba(37,99,235,.25);
}

#jlpt option{
  background-color:#f3f4f6 !important;
  color:#0f172a !important;
  
}
/* ========= (6)-(9) 新卒向け 追加パーツ用 ========= */

/* fieldset ကို card လိုနေရအောင် */


/* label ကို အပေါ်ကနေ clear ဖြစ်အောင် */
fieldset.full label{
  display:block;
  margin:10px 0 6px;
  font-weight:600;
}

/* Portfolio/GitHub input ကို full width ဖြစ်အောင် */
#portfolio, #github{
  width:80%;
  max-width:680px;
  display:block;
  margin-bottom:10px;
  padding:12px;
  border-radius: 12px;
  border:1px dotted;
}

/* ====== 技術 (checkbox) ကို grid ပုံစံ ====== */
.tech-grid{
  display:grid;
  grid-template-columns:repeat(2, minmax(0, 1fr));
  gap:10px 14px;
  margin-top:10px;
}

.tech-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border:1px solid #e5e7eb;
  border-radius:12px;
  background:#f9fafb;
}

/* checkbox အရွယ်အစားကို input style မထိအောင် */
.tech-item input{
  width:auto !important;
  margin:0;
}

/* ====== インターン (radio) ကို pill style ====== */
.radio-row{
  display:flex;
  gap:16px;
  margin-top:10px;
}

.radio-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border:1px solid #e5e7eb;
  border-radius:12px;
  background:#f9fafb;
}
.radio-item input{
  width:auto !important;
  margin:0;
}

/* ====== 自己PR ကို text input မဟုတ်ဘဲ textarea လို ပိုကောင်း ====== */
#selfPR{
  width:100%;
  max-width:680px;
  display:block;
  min-height:110px;      /* input ထက် ပိုသင့် */
  padding:10px 12px;
  border-radius:10px;
}

/* mobile */
@media (max-width:680px){
  .tech-grid{ grid-template-columns:1fr; }
  .radio-row{ flex-direction:column; }
}


/* ✅ ボタン */
.actions{
  display:flex;
  justify-content:flex-end;
  margin-top:6px;
}

.btn{
  appearance:none;
  border:0;
  cursor:pointer;
  padding:12px 22px;
  border-radius:12px;
  font-weight:700;
  font-size:16px;
  transition:transform .12s, box-shadow .12s, background .2s;
}

/* ✅ メインボタン：企業ブルー */
.btn-primary{
  background:#2563eb;
  color:white;
  box-shadow:0 10px 20px rgba(37,99,235,.3);
}

.btn-primary:hover{
  transform:translateY(-1px);
  box-shadow:0 16px 28px rgba(37,99,235,.35);
}

.hidden{display:none}


/* ✅ 資格・保有状況まわりの「謎の色帯」を完全削除 */
fieldset,
.full,
.row,
section,
div {
  background: transparent !important;
}

/* ✅ legend の色背景も削除 */
legend {
  background: transparent !important;
}

/* ✅ ラジオボタン周辺も白統一 */
label {
  background: transparent !important;
}

</style>

<body>
    <main class="glass-box">
      <h1>国籍とJLPTフォーム</h1>
      <form id="skillForm" action="#" method="post" novalidate>

        

        <!-- 1) 国籍 -->
        <fieldset class="full" aria-labelledby="nat-legend">
          <h2>1) 国籍 / Nationality</h2>
          <legend id="nat-legend">国籍</legend>
          <label><input type="radio" name="nationality" value="jp" required onclick="toggleJLPT(false)"> 日本人</label>
          <label><input type="radio" name="nationality" value="foreign" required onclick="toggleJLPT(true)"> 外国人</label>
        </fieldset>

        <!-- JLPT（外国人のみ） -->
        <div id="jlptBlock" class="full hidden">
          <fieldset>
            <legend>日本語（JLPT）</legend>
            <label for="jlpt">JLPT レベルを選択</label>
            <select id="jlpt" name="jlpt">
              <option value="">選択…</option>
              <option>N1</option>
              <option>N2</option>
              <option>N3</option>
              <option>N4</option>
              <option>N5</option>
            </select>
            <p style="margin:10px 0 6px">JLPT の証明書をアップロードしてください。</p>
            <input type="file" id="jlpt_certificate" name="jlpt_certificate" accept=".pdf,.doc,.docx">
          </fieldset>
        </div>

        <!-- 2) TOEIC -->
        <fieldset class="full" aria-labelledby="toeic-legend">
          <h2>2) 英語（TOEIC）</h2>
          <legend>保有状況</legend>
          <label><input type="radio" name="toeic_have" value="yes" onclick="toggleToeicScore(true)"> 持っている</label>
          <label><input type="radio" name="toeic_have" value="no" onclick="toggleToeicScore(false)"> 持っていない</label>

          <div id="scoreField" class="hidden" style="margin-top:10px">
            <label for="toeic_score">スコア</label>
            <input type="number" id="toeic_score" name="toeic_score" min="0" max="990" step="5" placeholder="例: 800">
            <p style="margin:10px 0 6px">TOEIC の証明書をアップロードしてください。</p>
            <input type="file" id="toeic_certificate" name="toeic_certificate" accept=".pdf,.doc,.docx">
          </div>
        </fieldset>

        <!-- 3) IT Passport -->
        <fieldset>
          <legend>3) ITパスポート（IT Passport）</legend>
          <label><input type="radio" name="ip_have" value="yes" onclick="toggleIP(true)"> 持っている</label>
          <label><input type="radio" name="ip_have" value="no" onclick="toggleIP(false)"> 持っていない</label>

          <div id="ipField" style="display:none; margin-top:10px">
            <p>IP の証明書をアップロードしてください。</p>
            <input type="file" id="ip_certificate" name="ip_certificate" accept=".pdf,.doc,.docx">
          </div>
        </fieldset>

        <!-- 4) Fundamental Engineer -->
        <fieldset>
          <legend>4) 基本情報技術者試験（FE）</legend>
          <label><input type="radio" name="fe_have" value="yes" onclick="toggleFE(true)"> 持っている</label>
          <label><input type="radio" name="fe_have" value="no" onclick="toggleFE(false)"> 持っていない</label>

          <div id="feField" style="display:none; margin-top:10px">
            <p>FE の証明書をアップロードしてください。</p>
            <input type="file" id="fe_certificate" name="fe_certificate" accept=".pdf,.doc,.docx">
          </div>
        </fieldset>

        <!-- 5) 履歴書 -->
        <fieldset class="full">
          <legend>5) 履歴書の添付</legend>
          <p style="margin:0 0 6px">PDF または Word 形式の履歴書を添付してください。</p>
          <input type="file" id="resume" name="resume" accept=".pdf,.doc,.docx">
        </fieldset>
        <!-- 6) Portfolio / GitHub -->
<fieldset class="full">
  <legend>6) ポートフォリオ・GitHub</legend>

  <label for="portfolio">ポートフォリオ URL</label>
  <input type="url" id="portfolio" name="portfolio" placeholder="https://..." />

  <label for="github">GitHub URL</label>
  <input type="url" id="github" name="github" placeholder="https://github.com/username" />
</fieldset>

<!-- 7) 使用技術 -->
<fieldset class="full">
  <legend>7) 使用技術（複数選択可）</legend>

  <div class="tech-grid">
    <label class="tech-item"><input type="checkbox" name="tech" value="HTML/CSS"> HTML / CSS</label>
    <label class="tech-item"><input type="checkbox" name="tech" value="JavaScript"> JavaScript</label>
    <label class="tech-item"><input type="checkbox" name="tech" value="React"> React</label>
    <label class="tech-item"><input type="checkbox" name="tech" value="Java"> Java</label>
    <label class="tech-item"><input type="checkbox" name="tech" value="SQL"> SQL</label>
    <label class="tech-item"><input type="checkbox" name="tech" value="Firebase"> Firebase</label>
    <label class="tech-item"><input type="checkbox" name="tech" value="Git"> Git</label>
  </div>
</fieldset>


<fieldset class="full">
  <legend>8) インターン経験</legend>
  <div class="radio-row">
    <label class="radio-item"><input type="radio" name="intern" value="yes"> あり</label>
    <label class="radio-item"><input type="radio" name="intern" value="no"> なし</label>
  </div>
</fieldset>


<fieldset class="full">
  <legend>9) 自己PR（100〜200文字）</legend>
  <textarea id="selfPR" name="selfPR" maxlength="200"
    placeholder="例：学習意欲が高く、継続力があります"></textarea>
</fieldset>


        <div class="actions">
          <button type="submit" class="btn btn-primary">送信</button>
        </div>
      </form>
    </main>
    

  </body>
  <script type="module">
    import { db } from "./js/firebase.js"; // Firestore はそのまま使う
import {
  doc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import { CLOUDINARY } from "./js/cloudinary.js"; 
// cloudinary.js に cloudName と uploadPreset を入れておく

/* ========== 配点ルール ========== */
const RULES = {
  nationality: { jp: 100, foreign: 0 },
  jlpt: { N1: 100, N2: 80, N3: 60, N4: 40, N5: 20, none: 0 },
  toeicMax: 100,
  ip: 60,
  fe: 80,
};

/* ========== ユーティリティ ========== */
const clean = (obj) =>
  Object.fromEntries(Object.entries(obj).filter(([, v]) => v !== null && v !== "" && v !== undefined));
const val = (sel) => document.querySelector(sel)?.value ?? "";
const checkedVal = (name) =>
  document.querySelector(`input[name="${name}"]:checked`)?.value ?? "";

/* ========== Cloudinary Upload ========== */
async function uploadToCloudinary(file) {
  if (!file) return null;

  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/raw/upload`;

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY.uploadPreset);

  const res = await fetch(url, {
    method: "POST",
    body: formData,
  });

  const data = await res.json();

  // エラー時
  if (data.error) {
    console.error("Cloudinary upload error:", data.error);
    alert("ファイルアップロードに失敗しました（Cloudinary）");
    return null;
  }

  return data.secure_url;
}

/* ========== スコア計算 ========== */
function computeScore(skill) {
  const nat = skill?.nationality === "jp" ? RULES.nationality.jp : RULES.nationality.foreign;
  const jl = RULES.jlpt[skill?.jlpt ?? "none"];
  let toeic = 0;

  if (skill?.toeic?.have === true) {
    const raw = Number(skill?.toeic?.score ?? 0);
    const clamped = Math.max(0, Math.min(990, isNaN(raw) ? 0 : raw));
    toeic = Math.round((clamped / 990) * RULES.toeicMax);
  }

  const ip = skill?.ip === true ? RULES.ip : 0;
  const fe = skill?.fe === true ? RULES.fe : 0;

  return {
    total: nat + jl + toeic + ip + fe,
    breakdown: { nationality: nat, jlpt: jl, toeic, ip, fe },
  };
}

/* ========== トグル ========= */
window.toggleJLPT = (isForeign) => {
  const block = document.getElementById("jlptBlock");
  const sel = document.getElementById("jlpt");
  const file = document.getElementById("jlpt_certificate");
  if (!block || !sel || !file) return;

  block.classList[isForeign ? "remove" : "add"]("hidden");
  sel.required = isForeign;
  file.required = isForeign;

  if (!isForeign) {
    sel.value = "";
    file.value = "";
  }
};

window.toggleToeicScore = (hasCert) => {
  const field = document.getElementById("scoreField");
  const scoreInput = document.getElementById("toeic_score");
  const file = document.getElementById("toeic_certificate");
  if (!field || !scoreInput || !file) return;

  field.classList[hasCert ? "remove" : "add"]("hidden");
  scoreInput.required = hasCert;
  file.required = hasCert;

  if (!hasCert) {
    scoreInput.value = "";
    file.value = "";
  }
};

window.toggleIP = (hasCert) => {
  const field = document.getElementById("ipField");
  const file = document.getElementById("ip_certificate");
  if (!field || !file) return;

  field.style.display = hasCert ? "block" : "none";
  file.required = hasCert;

  if (!hasCert) file.value = "";
};

window.toggleFE = (hasCert) => {
  const field = document.getElementById("feField");
  const file = document.getElementById("fe_certificate");
  if (!field || !file) return;

  field.style.display = hasCert ? "block" : "none";
  file.required = hasCert;

  if (!hasCert) file.value = "";
};

/* ========== 送信処理 ========== */
const form = document.getElementById("skillForm");

if (form) {

  window.addEventListener("DOMContentLoaded", () => {
    window.toggleJLPT(false);
    window.toggleToeicScore(false);
    window.toggleIP(false);
    window.toggleFE(false);
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) submitBtn.disabled = true;

    try {
      /* ====== 入力値 ====== */
      const qsRegNo = new URLSearchParams(location.search).get("regNo");
      const regNo = (qsRegNo || val("#regNo")).trim();

      if (!regNo) {
        alert("Applicant ID (regNo) を入力してください。");
        return;
      }

      const nationality = checkedVal("nationality");
      const jlptLevel  = val("#jlpt");
      const toeicHave  = checkedVal("toeic_have");
      const toeicScore = val("#toeic_score");
      const ipHave     = checkedVal("ip_have");
      const feHave     = checkedVal("fe_have");

      const jlptFile   = document.getElementById("jlpt_certificate").files[0] ?? null;
      const toeicFile  = document.getElementById("toeic_certificate").files[0] ?? null;
      const ipFile     = document.getElementById("ip_certificate").files[0] ?? null;
      const feFile     = document.getElementById("fe_certificate").files[0] ?? null;
      const resumeFile = document.getElementById("resume").files[0] ?? null;

      /* ====== バリデーション ====== */
      if (!nationality) return alert("国籍を選択してください。");

      if (nationality === "foreign") {
        if (!jlptLevel) return alert("JLPT レベルを選択してください。");
        if (!jlptFile) return alert("JLPT 証明書をアップロードしてください。");
      }

      if (toeicHave === "yes") {
        if (!toeicScore) return alert("TOEIC スコアを入力してください。");
        if (!toeicFile) return alert("TOEIC 証明書をアップロードしてください。");
      }

      if (ipHave === "yes" && !ipFile)
        return alert("ITパスポートの証明書をアップロードしてください。");

      if (feHave === "yes" && !feFile)
        return alert("FE の証明書をアップロードしてください。");

      if (!resumeFile)
        return alert("履歴書ファイルをアップロードしてください。");

      /* ====== Cloudinary Upload ====== */
      const jlptUrl   = await uploadToCloudinary(jlptFile);
      const toeicUrl  = await uploadToCloudinary(toeicFile);
      const ipUrl     = await uploadToCloudinary(ipFile);
      const feUrl     = await uploadToCloudinary(feFile);
      const resumeUrl = await uploadToCloudinary(resumeFile);

      const files = clean({
        jlpt: jlptUrl,
        toeic: toeicUrl,
        ip: ipUrl,
        fe: feUrl,
        resume: resumeUrl,
      });

      /* ====== skill 作成 ====== */
      const skill = clean({
        nationality,
        jlpt: jlptLevel || null,
        toeic:
          toeicHave === "yes"
            ? { have: true, score: toeicScore ? Number(toeicScore) : null }
            : { have: false },
        ip: ipHave === "yes",
        fe: feHave === "yes",
        files: Object.keys(files).length ? files : null,
      });
            /* =========================
         ✅ 追加: 新卒向け skill (②③④⑤⑥)
      ========================= */
      const portfolio = val("#portfolio").trim();
      const github = val("#github").trim();
      const selfPR = val("#selfPR").trim();

      const techs = Array.from(document.querySelectorAll('input[name="tech"]:checked'))
        .map(el => el.value);

      const intern = checkedVal("intern") === "yes";

      // ✅ score bonus（新卒向け）
      let bonus = 0;
      if (portfolio) bonus += 20;
      if (github) bonus += 15;
      if (selfPR) bonus += 5;
      const techCount = techs.length;
if (techCount >= 5) bonus += 20;
else if (techCount >= 3) bonus += 10;
else if (techCount >= 2) bonus += 5;

      if (intern) bonus += 15;
      if (selfPR) bonus += 5;

      // ✅ skill に追加
      skill.portfolio = portfolio || null;
      skill.github = github || null;
      skill.techs = techs.length ? techs : null;
      skill.intern = intern;
      skill.selfPR = selfPR || null;


      const base = computeScore(skill).total;
const finalScore = base + bonus;
skill.score = finalScore;


      /* ====== Firestore 保存 ====== */
      await setDoc(
        doc(db, "applicants", regNo),
        {
          skill,
          skill_view: {
            "01_nationality": nationality,
            "02_jlpt": jlptLevel,
            "03_toeic": skill.toeic,
            "04_ip": ipHave === "yes",
            "05_fe": feHave === "yes",
            "06_files": files,
            "07_portfolio": portfolio || null,
            "08_github": github || null,
            "09_techs": techs,
            "10_intern": intern,
            "11_selfPR": selfPR || null,
             score: skill.score,
          },
          skillAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        },
        { merge: true }
      );

     alert(`登録完了！(base=${base}, bonus=${bonus}, final=${finalScore})`);

      form.reset();
      window.toggleJLPT(false);
      window.toggleToeicScore(false);
      window.toggleIP(false);
      window.toggleFE(false);

    } catch (err) {
      console.error(err);
      alert("エラー: " + err.message);
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  });
}

    </script>

 </html> 
