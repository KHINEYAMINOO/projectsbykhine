<!DOCTYPE html>
<html lang="jp">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>registration form</title>
 
</head>
<style>
  /* å…¨ä½“ï¼šskill.cssé¢¨ã®ã‚„ã‚ã‚‰ã‹ã„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:#1f2937;
      background:
        linear-gradient(180deg,rgba(255,255,255,.45),rgba(0,0,0,.15)),
        url("https://images.unsplash.com/photo-1503264116251-35a269479413?q=80&w=1974&auto=format&fit=crop")
        center/cover no-repeat #e5e7eb;
    }

    .glass-box{
      width:min(92vw,740px);
      padding:26px 28px;
      border-radius:18px;
      background:#ffffffee;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 32px rgba(15,23,42,.16);
    }

    h2{
      margin:0 0 4px;
      font-size:24px;
      font-weight:600;
      color:#111827;
    }

    form{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px 18px;
      margin-top:10px;
    }
    .full{ grid-column:1/-1; }

    label{
      display:block;
      font-size:13px;
      color:#374151;
      margin:0 0 6px;
    }

    input{
      width:100%;
      padding:10px 12px;
      font-size:15px;
      color:#111827;
      background:#f9fafb;
      border:1px solid #d1d5db;
      border-radius:8px;
      outline:none;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    input::placeholder{ color:#9ca3af; }
    input:focus{
      border-color:#b1163a;
      box-shadow:0 0 0 2px rgba(177,22,58,.18);
      background:#ffffff;
    }

    .postal-row{
      display:flex;
      gap:8px;
      max-width:280px;
    }

    .btn-zip{
      appearance:none;
      border:1px solid #f9a8d4;
      cursor:pointer;
      padding:8px 14px;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      background:#fce7f3;
      color:#9f1239;
      transition:background .15s, border-color .15s, transform .1s;
      white-space:nowrap;
    }
    .btn-zip:hover{
      background:#fbcfe8;
      border-color:#f472b6;
    }
    .btn-zip:active{ transform:translateY(1px); }

    .postal-msg{
      display:block;
      margin-top:4px;
      min-height:1.2em;
      font-size:12px;
      color:#dc2626;
    }

    .actions{
      grid-column:1/-1;
      display:flex;
      justify-content:flex-end;
      margin-top:6px;
    }

    .btn-next{
      background:#b1163a;
      color:#ffffff;
      border:0;
      cursor:pointer;
      padding:12px 24px;
      border-radius:16px;
      font-weight:600;
      font-size:15px;
      box-shadow:0 8px 18px rgba(177,22,58,.28);
      transition:background .15s, transform .1s, box-shadow .15s;
    }
    .btn-next:hover{
      background:#991135;
      transform:translateY(-1px);
    }
    .btn-next:active{
      transform:translateY(0);
      box-shadow:0 4px 10px rgba(177,22,58,.22);
    }

    @media (max-width:680px){
      form{ grid-template-columns:1fr; }
    }

  </style>
<body>
  <main class="glass-box">
    <h2>å¿œå‹Ÿè€…ã®ç™»éŒ²</h2>

    <!-- â† å¿…ãšã“ã®IDã‚’ä»˜ã‘ã‚‹ -->
    <form id="entryForm" action="skill.html" method="get" novalidate>
      <div class="full">
        <label for="regNo">Applicant ID</label>
        <input type="text" name="registration_number" id="regNo"
               placeholder="ä¾‹: AP-123456" required autocomplete="off" />

        <div>
          <label for="uname">ãŠåå‰</label>
          <input type="text" name="uname" id="uname" placeholder="ä¾‹: äº•çŸ³ å¤ªéƒ" required autocomplete="name" />
        </div>

        <div>
          <label for="ruby">ãƒ•ãƒªã‚¬ãƒŠ</label>
          <input type="text" name="ruby" id="ruby" placeholder="ä¾‹: ã‚¤ã‚¤ã‚· ã‚¿ãƒ­ã‚¦" required />
        </div>

        <div>
          <label for="birthday">èª•ç”Ÿæ—¥</label>
          <input type="date" name="birthday" id="birthday" autocomplete="bday" />
        </div>

        <div>
          <label for="mail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" name="mail" id="mail" placeholder="ä¾‹: example@example.com" required autocomplete="email" />
        </div>

        <div>
          <label for="tel">é›»è©±ç•ªå·</label>
          <input type="tel" name="tel" id="tel" placeholder="ä¾‹: 09012345678" required autocomplete="tel" />
        </div>

       <div>
  <label for="postal">éƒµä¾¿ç•ªå·</label>
  <div class="postal-row">
    <input
      type="text"
      name="postal"
      id="postal"
      placeholder="ä¾‹: 123-4567"
      required
      pattern="^\d{3}-?\d{4}$"
      inputmode="numeric"
      autocomplete="postal-code"
    />
    <button type="button" id="zipSearch" class="btn-zip">æ¤œç´¢</button>
  </div>
  <small id="postalMsg" class="postal-msg"></small>
</div>


        <div class="full">
          <label for="address">ãŠå±Šã‘å…ˆä½æ‰€</label>
          <input type="text" name="address" id="address" placeholder="ä¾‹: å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºä¸­å´1-2-34" required autocomplete="street-address" />
        </div>

        <div class="actions">
          <button class="btn-next" type="submit" id="submit">æ¬¡ã¸</button>
        </div>
      </div>
    </form>
  </main>
</body>
<script type="module">
  import { db } from "./js/firebase.js";
import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

window.addEventListener("DOMContentLoaded", () => {

  /* =========================
     âœ… Applicant ID è‡ªå‹•ã‚»ãƒƒãƒˆ
  ========================= */
  const regNoParam = new URLSearchParams(location.search).get("regNo");
  const regNoInput = document.getElementById("regNo");
  if (regNoParam && regNoInput) {
    regNoInput.value = regNoParam;
  }

  /* =========================
     âœ… èª•ç”Ÿæ—¥ï¼šæœªæ¥æ—¥ã‚’é¸æŠä¸å¯ï¼ˆmax å±æ€§ï¼‰
  ========================= */
  const birthdayInput = document.getElementById("birthday");
  if (birthdayInput) {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    birthdayInput.max = `${yyyy}-${mm}-${dd}`;
  }

  /* =========================
     âœ… éƒµä¾¿ç•ªå· â†’ ä½æ‰€è‡ªå‹•å…¥åŠ›
  ========================= */
  const postalInput  = document.getElementById("postal");
  const addressInput = document.getElementById("address");
  const zipSearchBtn = document.getElementById("zipSearch");
  const postalMsg    = document.getElementById("postalMsg");

  if (zipSearchBtn && postalInput && addressInput && postalMsg) {
    zipSearchBtn.addEventListener("click", async () => {
      postalMsg.textContent = "";
      postalMsg.style.color = "#0f0e0eff";

      const raw = (postalInput.value || "").trim();
      const zipcode = raw.replace("-", "");

      if (!/^\d{7}$/.test(zipcode)) {
        postalMsg.textContent = "éƒµä¾¿ç•ªå·ã¯7æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      zipSearchBtn.disabled = true;
      zipSearchBtn.textContent = "æ¤œç´¢ä¸­â€¦";

      try {
        const res = await fetch(
          `https://zipcloud.ibsnet.co.jp/api/search?zipcode=${encodeURIComponent(zipcode)}`
        );
        const data = await res.json();

        if (data.status !== 200 || !data.results || data.results.length === 0) {
          postalMsg.textContent = "ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
          return;
        }

        const r = data.results[0];
        const baseAddress = `${r.address1}${r.address2}${r.address3}`;
        const current = addressInput.value.trim();

        if (!current || current.startsWith(baseAddress)) {
          addressInput.value = baseAddress;
        } else {
          addressInput.value = `${baseAddress} ${current}`;
        }

        postalMsg.style.color = "#101411ff";
        postalMsg.textContent = "ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸã€‚ç•ªåœ°ãªã©ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚";

      } catch (err) {
        console.error(err);
        postalMsg.textContent = "ä½æ‰€æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      } finally {
        zipSearchBtn.disabled = false;
        zipSearchBtn.textContent = "æ¤œç´¢";
      }
    });
  }

  /* =========================
     âœ… ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ â†’ Firestoreä¿å­˜
  ========================= */
  const form = document.getElementById("entryForm");
  const submitBtn = document.getElementById("submit");

  if (form && submitBtn && regNoInput) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const regNo = regNoInput.value.trim();
      if (!regNo) {
        alert("Applicant IDï¼ˆregNoï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      // ğŸ”½ èª•ç”Ÿæ—¥ãŒæœªæ¥æ—¥ã˜ã‚ƒãªã„ã‹ãƒã‚§ãƒƒã‚¯
      const birthdayEl = document.getElementById("birthday");
      if (birthdayEl && birthdayEl.value) {
        const birth = new Date(birthdayEl.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // ä»Šæ—¥ã® 00:00 ã«ãã‚ãˆã‚‹

        if (birth > today) {
          alert("èª•ç”Ÿæ—¥ã«æœªæ¥ã®æ—¥ä»˜ã¯å…¥åŠ›ã§ãã¾ã›ã‚“ã€‚");
          birthdayEl.focus();
          return;
        }
      }

      const entry = {
        applicantId: regNo,
        name:     document.getElementById("uname").value.trim(),
        ruby:     document.getElementById("ruby").value.trim(),
        birthday: document.getElementById("birthday").value || null,
        mail:     document.getElementById("mail").value.trim(),
        tel:      document.getElementById("tel").value.trim(),
        postal:   document.getElementById("postal").value.trim(),
        address:  document.getElementById("address").value.trim(),
      };

      try {
        submitBtn.disabled = true;

        await setDoc(
          doc(db, "applicants", regNo),
          {
            entry,
            entryAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          },
          { merge: true }
        );

        const q = new URLSearchParams({ regNo }).toString();
        window.location.assign(`skill.html?${q}`);

      } catch (err) {
        console.error(err);
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
      } finally {
        submitBtn.disabled = false;
      }
    });
  }

});

  </script>
</html>
